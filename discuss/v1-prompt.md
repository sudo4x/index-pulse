# 项目概述

这是一个专门用于指数投资和跟踪系统。项目主要有两大功能:
1、指数的跟踪与分析。（这部分功能暂时先不实现）
2、投资组合的跟踪和管理。（先实现这部分，需要完成从数据库设计，服务端接口开发，前端界面开发）

## 投资组合跟踪和管理功能概述

### 计算公式

#### 成本价

持股数 = ∑买入数量 + ∑红股数量 + ∑拆股所增数量 - ∑卖出数量 - ∑合股所减数量
摊薄成本 = (∑买入金额 - ∑卖出金额 - ∑现金股息) / 持股数
持仓成本 = ∑买入金额 / (∑买入数量 + ∑红股数量 + ∑拆股所增数量 - ∑合股所减数量)

#### 浮动盈亏

浮动盈亏额 ＝ (当前价 - 持仓成本) _ 多仓持股数
浮动盈亏率 ＝ 浮动盈亏额 / (持仓成本价 _ 持股数)
分市场浮动盈亏额 ＝ ∑个股浮动盈亏额
分市场浮动盈亏率 ＝ 分市场浮动盈亏额 / ∑(个股持仓成本 \* 个股持股数)

#### 累计盈亏

个股累计盈亏额 ＝ 多仓市值 - ∑买入金额 + ∑卖出金额 + ∑现金股息
个股累计盈亏率 ＝ 累计盈亏额 / ∑买入金额
分市场累计盈亏额 ＝ ∑个股累计盈亏额
无银转: 分市场累计盈亏率 ＝ 累计盈亏额 / ∑个股买入金额
有银转: 分市场累计盈亏率 = 累计盈亏额 / ∑转入金额

#### 当日盈亏

昨日市值 > 0:
当日盈亏额 = (现市值 - 昨收市值 + 当日∑卖出 - 当日∑买入)
当日盈亏率 = 当日盈亏额 / (昨市值 + 当日∑买入 + 当日∑卖空)

昨日市值 = 0:
当日盈亏额 = (现价 - 持仓成本) \* 股数 + 当日∑卖出 - 当日∑买入
当日盈亏率 = 当日盈亏额 / 当日∑买入

### 组合管理

- 支持新增，修改，删除，排序组合（组合中只有名字这个可编辑信息，没有其他信息）

### 组合概况信息

- 可查看的信息包括：总市值，今日盈亏，浮动盈亏，累计盈亏，总资产，现金，本金等
- 概况信息是通过累计所有持仓品种得来

### 持仓管理

- 持仓品种，可展示的信息包括：品种名称/代码，现价，涨跌（涨跌额和涨跌幅），市值，持仓数量，成本（摊薄/成本），浮动盈亏，累计盈亏
- 支持历史持仓股票（已清仓股票）的管理，可通过某个标志来确定是否显示历史持仓股票

### 交易管理

- 可查看的信息包括：股票名称+代码，类型+交易日期，成交价，数量，金额，说明，备注
- 支持组合下所有交易记录查询
- 支持单个品种的所有交易记录查询
- 交易类型包括：买入，卖出，合股，拆股，除权除息
- 交易记录支持添加，修改和删除，记录有变更（增加，修改，删除）会同时更新对应品种的统计数据，同时也会更新对应组合的统计数据
- 交易类型:
- **买入**: 股票名称+代码，组合，交易类型，委托日期，买入价，买入量，佣金（支持按千分比例或者元两种录入形式），税费（支持按千分比例或者元两种录入形式），备注
- **卖出**: 股票名称+代码，组合，交易类型，委托日期，卖出价，卖出量，佣金（支持按千分比例或者元两种录入形式），税费（支持按千分比例或者元两种录入形式），备注
- **合股**: 股票名称+代码，组合，交易类型，委托日期，多股合一（多少股合为1股），备注
- **拆股**: 股票名称+代码，组合，交易类型，委托日期，每股拆为（每1股拆2为多少股），备注
- **除权除息**: 股票名称+代码，组合，交易类型，委托日期，每10股转赠（股数），每10股送股（股数），每10股红利（金额 元），税费（支持按千分比例或者元两种录入形式），备注

### 转账记录管理

- 可查看的信息包括：操作类型（转入｜转出），金额，日期
- 支持组合下所有转账记录的查询
- 支持新增，修改和删除转账记录
- 支持转入转出2种转账方式
- 转账记录主要包括：转账方式，转账日期，金额三个信息
- 记录的更新也会同步更新组合相关的统计数据

## 数据结构

- 本系统基于 supabase PostgresSQL数据库，ORM框架使用 Drizzle
- 请参考其他系统相关接口数据 @discuss/api-example.md 参考他的结构来设计本系统的数据结构
- 需要考虑行情价格数据的实时变化会同步更新到品种持仓统计，组合持仓统计的数据，看看这部分计算出来的数据是否需要字段来存储
- 组合的市值，盈亏，资产等等数据需要支持历史数据，方便分析回顾走势
- 所有数据都是基于用户，不同用户之间的数据不相通

## 服务端接口

- 用户登录相关：使用supabase
- 组合管理相关：新增，修改，排序，删除，组合列表获取
- 组合中品种交易记录管理相关：新增交易记录，修改交易记录，删除交易记录，交易记录查询（支持查询所有和单一某个品种）
- 转账记录管理相关：新增，修改，删除转账记录
- 交易记录，转账记录的更新需要根据公式同步计算品种的汇总信息，组合的汇总信息

## 前端功能

### 组合管理

- 用户的所有组合通过tab形式的控件展开展示，每个组合一个tab，组合名称即tab页签的title，tab页签的右侧有添加组合 管理组合。可参考@src/app/(main)/dashboard/crm/\_components/table-cards.tsx
- 组合的tab内容：
- 首先是总市值，今日盈亏，浮动盈亏，累计盈亏，总资产，现金，本金等汇总概览信息的展示，要求显眼，美观，分类清晰。
- 汇总概览信息下面是另一个tab组合，包括持仓，交易记录，转账记录三个tab，tab页签右侧有显示历史持仓复选框，买入，卖出，银证转帐四个按钮。
- 持仓tab页展示持仓品种表格，表头为：名称/代码 现价 涨跌 市值 持仓 摊薄/成本 浮动盈亏 累计盈亏 操作，操作里面有记录，添加和删除三个按钮，点击 记录 按钮会显示该品种的所有交易记录，点击 添加 按钮会弹出添加交易对话框。
- 交易对话框是通过select控件进行选择交易方式，选择不同的交易类型会渲染不同的填入信息，每种交易类型对应的填入信息如下：
  - **买入**: 股票名称+代码，组合，交易类型，委托日期，买入价，买入量，佣金（支持按千分比例或者元两种录入形式），税费（支持按千分比例或者元两种录入形式），备注
  - **卖出**: 股票名称+代码，组合，交易类型，委托日期，卖出价，卖出量，佣金（支持按千分比例或者元两种录入形式），税费（支持按千分比例或者元两种录入形式），备注
  - **合股**: 股票名称+代码，组合，交易类型，委托日期，多股合一（多少股合为1股），备注
  - **拆股**: 股票名称+代码，组合，交易类型，委托日期，每股拆为（每1股拆2为多少股），备注
  - **除权除息**: 股票名称+代码，组合，交易类型，委托日期，每10股转赠（股数），每10股送股（股数），每10股红利（金额 元），税费（支持按千分比例或者元两种录入形式），备注
- 交易记录 通过表格展示，表头为：名称 类型 成交价 数量 金额 说明 备注 操作，操作里面有修改和删除两个按钮
- 转帐记录 通过表格展示，表头为：操作 金额 日期 操作，操作里面有修改和删除两个按钮

## 其他重要信息

- 当前的项目代码只是一个后端管理的模版代码，而且是英文的，本系统要用中文进行开发
- 前端样式要求按照当前项目的风格进行开发
- 目前项目代码中只有前端部分，没有API方面的结构，需要结合next.js的API规则和最佳实践帮我新增API实现模块的目录结构
- API部分使用supabase 的登录注册功能 和 PostgresSQL数据库，ORM框架使用 Drizzle，注册用magic link
- 侧边拦新增一个投资分类，投资组合管理放在该分类下
- 所有数据都是基于用户的
- 登录注册使用 @src/app/(main)/auth/v1 这个目录下的版本，v2 这个不要可以删除
- 股票名称+代码 这部分是通过数据代码查询出名称，涨跌幅那些，可以参考 @discuss/获取实时行情接口.md 实现一个查询接口供所有需要使用股票名称/代码，当前价格，涨跌等的地方使用
- 特别重要，组合的汇总信息，品种的汇总信息是通过交易记录，转账记录按照上面提供的计算公式计算得来，这个你在设计和实现中必须牢牢记住
