
# 历史持仓改造

## 仓位周期管理器 
相关代码 @src/lib/services/position-cycle-manager.ts
这个仓位周期管理的代码之前是为了计算累计盈亏加上的，现在累计盈亏这个概念已经去掉了，所以这部分代码目前是不需要的需要去掉。
同时transactions表中的positionCycleId字段也要删除掉，相关的代码也要一并检查并删除

去掉仓位管理周期相关代码后需要检查下以下逻辑是否满足：
1、holdings表中的isActive的更新逻辑是：如果一个品种清仓，那么这个字段变成false，如果重新买入建仓，那么是新增一个新的holding记录，isActive字段是true。transactions记录只需要和holdings表的ID关联就可以。
2、持仓品种列表接口 的逻辑是获取isActive为true的记录
3、已清仓品种列表接口 的逻辑是获取isActive为false的记录


## UI改造
目前是在持仓Tab下有一个“显示历史持仓”的checkbox，点击会显示历史持仓品种。
现在要改造成把历史持仓的品种列表单独出来变成一个独立的tab，叫 "已清仓"。
相关代码在@src/app/(main)/investment/portfolios/_components/holdings-table-container.tsx


## 其他注意点
以上的改动可能会影响一些其他已有功能，你需要深度思考一下有哪些影响，逐一分析，列出改造的细节。


## 已清仓品种表格优化
表头修改成如下所示：
名称/代码 实现盈亏 收益率 年化收益率 清仓价 现价 轻仓后距今

其他补充
现在 “名称/代码” 列下方有一个 “已清仓”的标识，需要加上日期，比如 2025-09-03清仓
实现盈亏 = holdings.totalSellAmount-holdings.totalBuyAmount
收益率 = (holdings.totalSellAmount-holdings.totalBuyAmount)/holdings.totalBuyAmount
年化收益率: 使用交易记录中的数据结合XIRR年化收益率算法实现（如果有必要引入第三方函数库，可以让我操作）
轻仓后距今 = 现价/清仓价 X 100%

相关文件 @src/app/(main)/investment/portfolios/_components/liquidated-holdings-table.tsx

补充
@src/lib/utils/xirr-calculator.ts 我希望你重构一下该文件，不需要提供尝试方法和降级方案严格按照原来的算法来。
calculateTransactionAmount 这部分计算涉及到了税费和佣金，其实不需要，只需要计算买卖两种交易的金额就可以。
@src/app/api/holdings/route.ts getTransactionsBySymbol这个函数放这里不合适，应该放service里面，然后函数需要改一下，只获取买卖类型的交易数据。你提供一个允许输入交易类型数组的参数来指定获取哪些类型的交易数据。

把年化收益率的相关代码全部清理掉，依赖包也删掉
把表格中原来 年化收益率 这列改成 持有天数 说明：持有天数从第一笔买入算起

 - src/lib/services/transaction-query-service.ts - 添加获取第一笔买入交易日期的方法 
这部分我觉得不好，holding中有一个openTime 用这个字段来计算就可以，但是你需要检查一下这个字段有没有在首次买入是更新。


在把 年化收益率 列再加回来，但是计算方法变了，改成简易版计算公式
计算公式（简化版）：年化收益率 = [(1 + 收益率) ^ (365 / 持股天数) - 1] × 100%

把原来 收益率及计算公式有问题，多乘以100了 
  const realizedProfitRate = holdingData.totalBuyAmount > 0 ? (realizedProfit / holdingData.totalBuyAmount) * 100 : 0;


轻仓后距今 算法也不对，不用乘以100
清仓品种表颜色表示，红涨绿跌 红盈利率亏损
清仓表的操作列只需要保留交易菜单，其他的不需要
以后这个项目的对于涨跌盈亏的红色表示统一为 红涨绿跌，红盈绿亏 这个很重要加到项目记忆中